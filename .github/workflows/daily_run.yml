name: Daily Subsidy Data Update

on:
  schedule:
    - cron: '0 0 * * *' # 日本時間 午前9時 (UTC 0:00)
  workflow_dispatch: # 手動実行用

jobs:
  update-data:
    runs-on: ubuntu-latest
    # 【最優先事項】OIDCトークン発行のために必須の権限
    permissions:
      contents: read
      id-token: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      # 1. Google Cloud 認証ステップ（Workload Identity）
      - name: Google Auth
        uses: google-github-actions/auth@v2
        with:
          workload_identity_provider: ${{ secrets.GCP_WORKLOAD_IDENTITY_PROVIDER }}
          service_account: ${{ secrets.GCP_SERVICE_ACCOUNT_EMAIL }}

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'

      # 2. 必要なライブラリのインストール
      - name: Install dependencies
        run: pip install requests google-api-python-client oauth2client

      - name: Run script with error handling and logs
        env:
          AIRTABLE_API_KEY: ${{ secrets.AIRTABLE_API_KEY }}
          AIRTABLE_BASE_ID: ${{ secrets.AIRTABLE_BASE_ID }}
        run: |
          python -c "
          import os
          import datetime
          import sys

          def run_update():
              try:
                  # 1. 依存関係と環境変数のチェック
                  print(f'[{datetime.datetime.now()}] Starting daily run...')
                  api_key = os.environ.get('AIRTABLE_API_KEY')
                  if not api_key:
                      raise ValueError('Missing AIRTABLE_API_KEY')
                  print('Check: API Key found.')

                  # 2. 物理定数・単位のシミュレーション（例：補助金額の計算など）
                  raw_value = 100000 # SI単位系（円）
                  tax_rate = 0.1
                  final_value = raw_value * (1 + tax_rate)
                  print(f'Calculation Step: {raw_value} * (1 + {tax_rate}) = {final_value}')

                  # 3. 実行メイン（実際のスクリプト呼び出し）
                  # ここで main.py 等を呼び出す、またはここにAPI送信コードを記述
                  print('Main process completed successfully.')

              except Exception as e:
                  print(f'Error occurred: {str(e)}')
                  sys.exit(1)

          run_update()
          "
